# Analysis Guide

***TO BE UPDATED***

This is a guide to extracting data from GSD files generated by HOOMD-blue simulations and running basic analyses for research in the PRO-CF Colloids Team.

This guide is optimized for MacOS. See [Simulating waterDPD](/02-Simulating-waterDPD.md) for help running colloids simulations with HOOMD-blue.

[Last Update: August 2022]

Different parts of our analysis workflow were developed by Mohammad (Nabi) Nabizadeh and Dr. Deepak Mangal. They were streamlined for this guide by Rob Campbell.

## Contents
1. [Types of Analysis](/05-Analysis-Guide.md#types-of-analysis)
2. [Basic Analyses of waterDPD](/05-Analysis-Guide.md#basic-analyses-of-waterdpd)
3. [Modyfing waterDPD and Analyzing the Changes](/05-Analysis-Guide.md#modyfing-waterdpd-and-analyzing-the-changes)
4. [Shearing waterDPD](/05-Analysis-Guide.md#shearing-waterdpd)
5. [(OPTIONAL) Installing R](/05-Analysis-Guide.md#optional-installing-r)

## Old Contents
1. [Why Choose R](/05-Log-Analysis-with-R.md#why-choose-r)
2. [Getting and Installing R, RStudio, and the Tidyverse](/05-Log-Analysis-with-R.md#getting-and-installing-r-rstudio-and-the-tidyverse)
3. [The RStudio Console](/05-Log-Analysis-with-R.md#the-rstudio-console)
4. [Creating a New R Script](/05-Log-Analysis-with-R.md#creating-a-new-r-script)
5. [Loading and Checking Data](/05-Log-Analysis-with-R.md#loading-and-checking-data)
6. [Plotting Data](/05-Log-Analysis-with-R.md#plotting-data)
7. [Analyzing `.log` Files While Running Simulations](/05-Log-Analysis-with-R.md#analyzing-log-files-while-running-simulations)
8. [The Importance of Temperature](/05-Log-Analysis-with-R.md#the-importance-of-temperature)
9. [Next Steps](/05-Log-Analysis-with-R.md#next-steps/)
<br>


## Types of Analysis 

For qualitative analysis of a simulation we always view the GSD file in VMD to visualy inspect the results.

The primary way to collect quantitative data from a HOOMD-blue simulation is to save data to the GSD file. 

Generally the best practice is to a run a simulation and then, after the simulation is completed, extract specific data from the GSD file as needed. This is the method we will discuss here. It is also possible to output data to a table as you run the simulation, and to save that table to a file (as explained in the [HOOMD-blue documentation](https://hoomd-blue.readthedocs.io/en/latest/tutorial/02-Logging/04-Writing-Formatted-Output.html)).

We usually work with the data in a GSD file in one of three ways:
1. For basic analyses (such as confirming that a simulation has run correctly), we usually use a python script to extract data from the GSD file and then plot it with [Matplotlib](https://matplotlib.org/).
2. For more intensive analyses (such as calculating average contact number, mean squared displacement, pair correlation function, etc.), we usually use a Fortran module to efficiently calculate these values from the GSD data. The Fortran module is run from a Python script using f2py.
3. For more plotting options and more efficient statistical analysis, members of our group have also developed a variety of analysis processes in the [R](https://www.r-project.org/) programming language.

This tutorial focuse on basic analyses (type 1), and provides some advice on installing and learning R (type 3). Information about the Fortran module is included in the [Gelation and Shearing guide](/06-Gelation-and-Shearing.md).
<br>
<br>
## Basic Analyses of waterDPD

Start by viewing the Equilibrium.gsd file in VMD. You should be able to see the water particles start with very fast motion that slowly equilibrates and reaches a steady state by the end of the simulation (see [Using VMD](/04-Using-VMD.md) for more advice on visualizing the simulation).

The basic qunatitive analyses to confirm that this simulation has run correctly are to plot the change in system kinetic temperature (kT) over time, and the change in the negative of the xy-component of the pressure tensor (AKA the shear stress) over time.

To do this we first extract these data from the GSD file using a Python script, and then we plot the data.

Go to the waterDPD-sims folder and cd into the waterDPD/analysis folder.

The extractdata-waterDPD.py script extract the temperature and xy-component of the pressure tensor from each frame of the Equilibrium.gsd file and saves it to a file called "gsd-properties.txt" (labeled with the DPD time the frame occured at).

The plot-kT.py script uses the gsd-properties.txt data to plot temperature versus DPD time. This should show a large spike in temperature at the start of the simulation, which then stabilizes at the chosen kT value (in this case kT = 0.1).

The plot-shearstress.py script uses the gsd-properties.txt data to plot shear stress versus DPD time. This should show a relatively constant average around zero (becuase no shear is being applied to the equilibrium simulation).
<br>
<br>
## Modyfing waterDPD and Analyzing the Changes

Now that we've successfully run a simple simulation, we can play around with it.

### Change simulation parameters
1. Try reruning the simulation for different lengths (change N_timesteps) and then see how the simulation visually and quantitatively changes.

2. Try rerunning the simulation for different system temperatures (change kT) and see how the simulation visually and quantitatively changes.

### Manipulate the particles:

In addition to changing the simulation parameters we typically set, you can access the invidual particles in a simulation and change their parameters as well.

For example, the particle-arch folder in waterDPD-sims contains a script where the position of particles in the center of the simulation are moved into a semi-circle, turning the initial configuration of the system into an arch shape. 

If you look at the script you'll see that after randomly distributing the particles in the simulation box for init.gsd, we access the particle positions and move them into the arch shape.

If you run the simulation and open it's Equilibrium.gsd file in VMD, you will be able to see what this looks like.

This method can also be used to change other particle parameters, such as giving them an initial velocity.
<br>
<br>
## Shearing waterDPD






## (OPTIONAL) Installing R





## Extracting Data from GSD



## Checking Thermal Equilibrium



## Checking Gelation

## Checking Shearing

## Efficient Analysis in Fortran

## Using R for Statistical Analysis

## Modifying waterDPD.py

In addition to the simulation parameters we typically set, you can also access most other parameters of the partiles in the simulation when running a simulation. 

For example, after randomly distributing the particles in your simulation box for init.gsd, you can move them to specific locations (or change their velocity, etc.) before running the simulation.

As an extreme example, take a look at the particle-arch folder.



## Why Choose R

To analyze the `.log` file genearted by a HOOMD-blue colloids simulation we will primarily be plotting the numbers stored in the file. This can easily be done in R, Python, MATLAB, or other software and programming languages, but the quality of plotting options in R, and it's versatility and ease of use for statistical analysis, makes it by far the best choice (even if the syntax can take a little while to get used to).
<br>
<br>
## Getting and Installing R, RStudio, and the Tidyverse

You can install R directly from the [R Project website](https://www.r-project.org/) by downloading from a CRAN mirror (to get automatically redirected to the closest available mirror, use the "0-Cloud" link)<br>
*Note: If you are downloading for MacOS there are two releases of the latest version of R, one for Intel-based computers and one for computers with Apple silicon (ARM processors). Be sure to choose the correct version for your needs.*

Once you have installed R you should install RStudio from the RStudio website, by choosing the [free desktop version](https://www.rstudio.com/products/rstudio/download/#download)<br>
*Note: The website should automatically detect your operating system and give you the correct download link.*

For getting started with R, it is recommended that you install the [tidyverse](https://www.tidyverse.org/) collection of packages designed for data science. You can do this in RStudio by going to the Console and running
```console
install.packages("tidyverse")
```

You are now ready to use R!

**Pro Tip**: Got to "RStudio" on the MacOS Menu Bar and select "Preferences..." to open the Options window. Select "Code" from the sidebar. On the "Display" tab you can check a box to turn on "Rainbow parentheses." This will change the color of nested parentheses to a ROYGBIV order, so that the outermost are red and the innermost are purple. This can make it easier to keep track of nested parentheses and avoid parentheses-related errors.

If you would like to modify the appearance of RStudio further, go to "Appearance" in the sidebar of the Options window to change the overall "RStudio theme", adjust the font and font size, and/or change your "Editor theme" to match your color preferences (or to match another IDE, such as "Eclipse").
<br>
<br>
## The RStudio Console

RStudio has 4 main sections
1. [top-left] A new or existing file, where you write your R scripts. *This will only be visible if you have a file open.*
2. [bottom-left] A Console, Terminal, and Jobs manager. You can use the Console for basic math, to run R commands separate from a full script, etc. The Console will also display the status of executed code from an R script file.
3. [top-right] A list of data sets loaded into the Environment, as well as History, Connections, and Tutorial tabs.
4. [bottom-right] A Files viewer, Plots, available Packages, Help, and general Viewer.

To get started we will write our code in a file in the top-left, view information about executed code in the Console at the bottom-left, and view Plots in the bottom-right.
<br>
<br>
## Creating a New R Script

Go to the "File" menu on the MacOS Menu Bar, and select "New File," "R Script."

This guide will walk you through how to write an R script for analyzing `.log` files from HOOMD-blue simulations. The completed [sample-r-analysis.R](/sample-r-analysis.R) script is also available as part of this repository.
<br>
<br>
## Loading and Checking Data

In the R Script, create a data frame named "P" to read the `Pressure_xy.log` file (or another `.log` file of your choice)
```r
P.df = read.table(file = "~/file_location", header = T)
```
*Note: when entering the file location, you can use the "tab" key to view available file path options and autocomplete with "return")*

With the cursor on this line, hold the "command" key and hit "return" to load the file. 

Now that the file is loaded, we should check the first few lines to understand the formatting. In the R script type
```r
head(P.df)
```
and then command+return.

In the Console section [bottom-left] you will see the line of code that you executed, and the first 6 lines of the file (your values for `pressure_xy` and `temperature` will vary with your simulation)
```console
> head(P.df)
  timestep pressure_xy temperature
1        0  0.11098247  0.00000000
2        1  0.10851238  0.02589183
3        2  0.10361774  0.09799322
4        3  0.09769909  0.20621219
5        4  0.08895702  0.34156559
6        5  0.07994112  0.49465869
```
We can see that the file has 3 columns of data, and the first line in each column is not a data point, it's the label for that column.

In addition to viewing the head of a file it is good to get a summary overview of the full data set. This can help you catch any weird things that might have happened (e.g. if temperature was set to 1 but reaches 1000, or if any basic statistical analyses give you an "N/A" value instead of a number).
Back in the R script, add
```r
summary(P.df)
```
and command+enter to run it.

The Console should display something like:
```console
> summary(P.df)
    timestep      pressure_xy         temperature    
 Min.   :  0.0   Min.   :-0.121535   Min.   :0.0000  
 1st Qu.:249.8   1st Qu.:-0.038633   1st Qu.:0.1051  
 Median :499.5   Median :-0.013924   Median :0.1204  
 Mean   :499.5   Mean   :-0.016007   Mean   :0.2323  
 3rd Qu.:749.2   3rd Qu.: 0.002718   3rd Qu.:0.2157  
 Max.   :999.0   Max.   : 0.110982   Max.   :1.6282 
```
You can see there are 1000 timesteps (0-99), the pressure ranges from approximately -0.1 to 0.1, and the termperature ranges from 0 to about 1. All looks good!

Another way to check the data is to view the full data set in a table (similar to an Excel sheet). <br>
In the R script add
```r
View(P.df)
```
and command+enter. This creates a new file with the data displayed as a table. This file will open as a new tab in the top-left section (temporarily hiding the R script from view).
<br>
<br>
## Plotting Data

Go back to the R Script file and let's plot the data!

Start with temperature vs. time. We already loaded each column of the data from `Pressure_xy.log` into the dataframe `P.df`, so we can assign those variables to the x and y axes with `P.df$variable-name`:
```r
plot(x = P.df$timestep, y = P.df$temperature, xlab = "Time", ylab = "Temperature")
```
The attributes `xlab` and `ylab` set the x-axis label and y-axis label, respectively.

Command+enter to plot the data. The command will be executed in the Console, and when it finishes running, the plot will appear in the bottom-right section.

You'll see that the temperature briefly spikes above 1.5 before dropping and stabilizing around 0.1. 

Go ahead and view the `waterDPD.py` script. Either open the file with your preferred IDE, or open a Temrinal window alongside R Studio and 
```bash
vim /repositories/HOOMDblue/sims/water/waterDPD.py
```
Looking at the "INPUTS" you can see that we set the temperature to 0.1 (i.e. `KT=.1`). In the simulation the temperature shoots up, as the particles start moving, but it goes back down to 0.1 because of the dissipative force (i.e. viscosity) in our dissipative particle dynamics (DPD) model. The dissipative force takes away the extra energy from the initiated particle motion, and the simulation stabilizes to equilibrium conditions. This is an important first step for all our simulations.

Check to see if it really does go to 0.1 by adding a red dashed line at 0.1:
```r
lines(x = c(-100, 2000), y = c(0.1, 0.1), lty=2, col='red', lwd=2)
```

Now check another parameter: pressure vs. time
```r
plot(x = P.df$timestep, y = P.df$pressure, xlab = "Time", ylab = "Pressure")
lines(x = c(-100, 2000), y = c(0, 0), lty=2, col='red', lwd=2)
```
This should start noisy but eventually even out to an oscillation around 0.

Remember that we're plotting something more specific than just "pressure." Pressure is a tensor with multiple directions, and if you look back at `waterDPD.py` you'll remember that we specifically chose in `hoomd.analyze` to log the pressure in the x-y direction. This was chosen so that we could eventually look at shear stress (tau = -P), but there's no shear yet. Our `waterDPD.py` does not include a shearing term. The first step of a shearing simulation will also be to bring the system to equilibrium, which is all that `waterDPD.py` currently does. At equilibrium the pressure in the x-y direction (negative shear) should oscillate around 0 (in our case, between -0.5 and 0.5).

You can also check this by looking back at `summary(P.df)`. The average pressure is indeed close to 0 (our example is -0.016007). If you run the simulation for longer, say 10,000 timesteps, you should get much closer to 0.
<br>
<br>
## Analyzing `.log` Files While Running Simulations

You can also use R to track a simulation's progress as it runs.

Let's check the simulation again: Does the temperature remain at 0.1 and the pressure average at 0 for longer timesteps?

Go back to `waterDPD.py` and increase the runtime by changing `N_time_steps` to 10,000. Then source to VirtEnv and run the simulation (see [Running a Simulation](/02-Simulating-waterDPD.md#running-a-simulation) in Simulating waterDPD.py for full steps).

While the simulation runs, go back to RStudio and in the R script add
```r
nrow(P.df)
```
and command+enter to run it. 

You should see the current numebr of lines displayed in the Console. You can execute this command again and watch the number of lines increase towards 10,000 as the simulation runs.

You can also replot the temperature plot and the pressure plot while the simulation is running. This will only plot the amount of data that has been logged at the time you run the command, but you can continue to update the plots as the simulation finishes.

Is temperature conserved? Does pressure go to zero?
<br>
<br>
## The Importance of Temperature

Typically when running a simulation in HOOMD-blue you will want to output a `.gsd` file for visualization and a `.log` of temperature and pressure. Temperature is necessary to track for a variety of reasons, but **most importantly** because we are running a dissipative particle dynamics (DPD) simulation. 

***Always check that temperature is conserved to verify that the DPD simulation is running properly.***

A working DPD simulation will maintain a steady temperature around the value we set for KT. If temperature is not conserved, that is a sign that the simulation is not running properly.

Temperature is conserved by the dissipative force, which you can modify with gamma (which determines viscosity, to some extent). A larger gamma value means a stronger dissipative force, which means the DPD simulation will be better at dissipating extra energy. If gamma is too high, too much energy will dissipate for the simulation to accurately represent particle interactions; but, if gamma is too low, the system will not equillibriate.

To test this, go back to `waterDPD.py` and lower gamma significantly (gamma=0.1) and rerun the simulation. In RStudio, plot the temperature to see the results.

Even after 10,000 timesteps, the simulation should still struggle to get down to a temperature of KT=0.1. For this simulation with a gamma this low it will probably need 30,000-40,000 timesteps to stabilize. And remember, stabilizing temperature (to achieve equilibrium) is only the first step before simulating shear or anything else.

Rerunning the pressure (i.e. negative shear) plot at this low gamma should also show more instability, with peaks easily reaching -0.1/0.1 in the later parts of the simulation.

This should help demonstrate how important it will be to find the right balance of values to enter into our simulations, to both accurately model a system and to minimize the time needed to complete a simulation.

***Typically you should use the diffusion time to estimate how long a simulation needs to be run to reach equilibrium (the standard is to run for 500 diffusion times).*** Some systems, like those with low-frequency vibrations, will probably equilibriate faster. Once you start working on a project you can usually find advice on these parameters in the literature specific to your system.
<br>
<br>
## Next Steps

*Learning R:*
* If you would like to learn more about using R, check out the LinkedIn Learning courses and other resources listed in the [Programming Resources](/Programming-Resources#r)



You should now be familiar with all the basic steps required for our research!
* [installed HOOMD-blue](/01-HOOMDblue-Install-Guide.md)
* learned the [basics of DPD](/Background-Reading/1-DPD-8pg.pdf)
* ran a [basic DPD simulation of water](/02-Simulating-waterDPD.md)
* [installed](/03-VMD-Install-Guide.md) and [worked with](/04-Using-VMD.md) VMD to visualize your simulation
* and ran basic analysis checks on the simulation to verify it ran correctly

The next step is to actually put this all to work with some colloids:
* If you haven't already, [install our modified version of HOOMD-blue](/01-HOOMDblue-Install-Guide.md#installing-hoomd31-mod) so you can run colloid simulation
* Read the [Gelation and Shearing Guide](/06-Gelation-and-Shearing.md) for guidance on using our mods to simulate colloids


 

